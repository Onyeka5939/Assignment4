name: Docker Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Create .env file from secrets
      run: |
        echo "APP_MESSAGE=${{ secrets.APP_MESSAGE }}" >> .env
        echo "APP_HEALTH=${{ secrets.APP_HEALTH }}" >> .env
        
    - name: Debug - Verify .env file creation
      run: |
        echo "Checking if .env file exists..."
        if [ -f .env ]; then
          echo ".env file created successfully!"
          echo "File contents (masked):"
          cat .env | sed 's/=.*/=***REDACTED***/g'
        else
          echo ".env file NOT found!"
          exit 1
        fi
        
    - name: Build Docker image
      run: docker build -t flask-devops-app .
      
    - name: Run Docker container
      run: |
        docker run -d -p 5000:5000 --env-file .env --name test-container flask-devops-app
        sleep 5
        
    - name: Test application endpoints
      run: |
        echo "Testing home route..."
        curl -f http://localhost:5000/ || exit 1
        echo "Testing health route..."
        curl -f http://localhost:5000/health || exit 1
        echo "All tests passed!"
        
    - name: Stop container
      if: always()
      run: docker stop test-container || true